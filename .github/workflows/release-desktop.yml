name: Release Desktop App

on:
  push:
    tags:
      - "desktop-v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build-desktop.yml
    with:
      channel: stable
      electron_builder_config: electron-builder.ts
      artifact_prefix: desktop
      artifact_retention_days: 30
    secrets: inherit

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: desktop-*
          merge-multiple: true

      - name: Create stable-named copies for latest download URLs
        run: |
          cd release-artifacts
          # Create stable-named copies (without version) for /releases/latest/download/ URLs
          for file in *.dmg; do
            if [[ -f "$file" ]]; then
              # Extract architecture from filename (e.g., Superset-0.0.1-arm64.dmg -> arm64)
              arch=$(echo "$file" | sed -E 's/.*-([^-]+)\.dmg$/\1/')
              cp "$file" "Superset-${arch}.dmg"
              echo "Created stable copy: Superset-${arch}.dmg"
            fi
          done
          for file in *-mac.zip; do
            if [[ -f "$file" ]]; then
              # Extract architecture from filename (e.g., Superset-0.0.1-arm64-mac.zip -> arm64)
              arch=$(echo "$file" | sed -E 's/.*-([^-]+)-mac\.zip$/\1/')
              cp "$file" "Superset-${arch}-mac.zip"
              echo "Created stable copy: Superset-${arch}-mac.zip"
            fi
          done
          echo "Release artifacts:"
          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts/*
          draft: true
          generate_release_notes: true
          name: Superset Desktop ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
